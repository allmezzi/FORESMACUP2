<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form Pendaftaran</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin:auto; }
    label { display:block; margin-top:10px; }
    select, input { width:100%; padding:8px; margin-top:5px; }
    button { margin-top:15px; padding:10px 20px; }
    #deviceBox { margin-top:20px; font-size:0.9em; color:#333; background:#f5f5f5; padding:10px; border-radius:6px; }
    #warningBox { margin-top:10px; color:red; font-weight:bold; }
  </style>
</head>
<body>
  <h2>Form Pendaftaran Acara</h2>
  <form id="mainForm">
    <label>Email Address <input type="email" name="email" required></label>
    <label>Nama Lengkap <input type="text" name="nama" required></label>
    <label>Instansi/OPD <select name="instansi"></select></label>
    <label>Status Kepegawaian 
      <select name="status" id="statusSelect"></select>
    </label>
    <label>NIP <input type="text" name="nip" id="nipField"></label>
    <label>Usia <select name="usia"></select></label>
    <label>Jabatan <select name="jabatan"></select></label>
    <label>Nomor HP/WA <input type="text" name="hp"></label>
    <label>Jenis Kelamin <select name="gender"></select></label>
    <label>Nama Acara <select name="acara"></select></label>
    <button type="submit">Submit</button>
	
	<div id="spinner" style="display:none; text-align:center; margin-bottom:15px;">
	  <div style="display:inline-block; width:40px; height:40px; border:4px solid #ccc; border-top-color:#1d72b8; border-radius:50%; animation:spin 1s linear infinite;"></div>
	  <div>Loading...</div>
	</div>

	<style>
	@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
	</style>

	
  </form>

  <div id="result"></div>
  <div id="deviceBox">🔄 Memuat Device ID...</div>
  <div id="warningBox"></div>

  <script>
      const apiUrl = "https://script.google.com/macros/s/AKfycbwOI8RQJuxOQb8PEq2JOeANCIXlwM_mznPS_uMteogNpOXwopu6KoCspjoaT1iDiDYj/exec";
      
      async function loadOptions() {
		  const spinner = document.getElementById("spinner");
		  spinner.style.display = "block"; // tampilkan spinner

		  try {
			const res = await fetch(apiUrl + "?action=getOptions", { cache: "no-store" });
			const data = await res.json();

			function setOptions(name, arr) {
			  const sel = document.querySelector(`[name='${name}']`);
			  if (!sel) return;
			  sel.innerHTML = "<option value=''>-- Pilih --</option>";
			  arr.forEach(v => { 
				const o = document.createElement("option"); 
				o.value = v; 
				o.textContent = v; 
				sel.appendChild(o); 
			  });
			}

			setOptions("instansi", data.instansi || []);
			setOptions("status", data.status || []);
			setOptions("usia", data.usia || []);
			setOptions("jabatan", data.jabatan || []);
			setOptions("gender", data.gender || []);
			setOptions("acara", data.acara || []);

		  } catch (err) {
			document.getElementById("result").textContent = "Gagal memuat opsi: " + err;
		  } finally {
			spinner.style.display = "none"; // sembunyikan spinner
		  }
		}
      
      async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,"0")).join("");
      }
      
      async function checkDeviceToday(deviceID) {
        try {
          const res = await fetch(apiUrl + "?action=checkDevice&deviceID=" + encodeURIComponent(deviceID));
          const data = await res.json();
          if (data.used) {
            document.getElementById("warningBox").textContent = "⚠️ Device ini sudah melakukan input hari ini.";
            document.querySelectorAll("#mainForm input, #mainForm select, #mainForm button").forEach(el=>el.disabled=true);
          }
          return data.used;
        } catch(err){
          console.error("checkDevice error:", err);
          return false;
        }
      }
      
      async function getFingerprint() {
        const userAgent = navigator.userAgent;
        const screenRes = `${screen.width}x${screen.height}`;
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const language = navigator.language;
      
        let ip = "N/A";
        try {
          let res = await fetch("https://api.ipify.org?format=json");
          ip = (await res.json()).ip;
        } catch(e){ console.warn("Gagal ambil IP:", e); }
      
        const raw = `${userAgent}|${screenRes}|${timezone}|${language}|${ip}`;
        const deviceID = await sha256(raw);
        document.getElementById("deviceBox").textContent = `Device ID: ${deviceID} | IP: ${ip}`;
        checkDeviceToday(deviceID);
        return { deviceID, ip };
      }
      
      document.getElementById("mainForm").addEventListener("submit", async e => {
		  e.preventDefault();
		  const spinner = document.getElementById("spinner");
		  spinner.style.display = "block"; // tampilkan spinner saat submit

		  const formData = Object.fromEntries(new FormData(e.target).entries());
		  const fp = await getFingerprint();
		  formData.deviceID = fp.deviceID;
		  formData.ip = fp.ip;

		  try {
			const res = await fetch(apiUrl, {
			  method: "POST",
			  body: JSON.stringify(formData)
			});
			const result = await res.json();
			document.getElementById("result").textContent = result.message;

			if (result.status === "success") {
			  e.target.reset();
			  setTimeout(() => { location.reload(); }, 500);
			}

		  } catch (err) {
			document.getElementById("result").textContent = "Error saat submit: " + err;

		  } finally {
			spinner.style.display = "none"; // sembunyikan spinner
		  }
		});
      
      document.addEventListener("change", e=>{
        if(e.target.id==="statusSelect"){
          const nipField = document.getElementById("nipField");
          nipField.disabled = (e.target.value.toLowerCase()==="honorer");
          if(nipField.disabled) nipField.value="";
        }
      });
      
      loadOptions();
      getFingerprint();
  </script>

</body>
</html>
